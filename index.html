<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>存歌&冠歌</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #e0eaff; /* bg-bluepurple-100 */
        }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .record-row:hover {
            background-color: #f0f5ff;
        }
        .crown-card {
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .crown-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .songs-list {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 200px;
        }
        
        /* 調整圓角為更方一點 */
        .rounded-custom {
            border-radius: 4px; /* Changed from 6px */
        }
        .rounded-custom-sm {
            border-radius: 2px; /* Changed from 4px */
        }
        .rounded-custom-lg {
            border-radius: 6px; /* Changed from 8px */
        }
        
        /* 自定義藍紫色調 */
        .bg-bluepurple-50 { background-color: #f0f5ff; }
        .bg-bluepurple-100 { background-color: #e0eaff; }
        .bg-bluepurple-200 { background-color: #c7d5ff; }
        .bg-bluepurple-300 { background-color: #a5b9ff; }
        .bg-bluepurple-400 { background-color: #8a9eff; }
        .bg-bluepurple-500 { background-color: #6b7eff; }
        .bg-bluepurple-600 { background-color: #5464db; }
        .bg-bluepurple-700 { background-color: #4050b5; }
        .bg-bluepurple-800 { background-color: #2d3c8f; }
        .bg-bluepurple-900 { background-color: #1e2a6a; }
        
        .text-bluepurple-50 { color: #f0f5ff; }
        .text-bluepurple-100 { color: #e0eaff; }
        .text-bluepurple-200 { color: #c7d5ff; }
        .text-bluepurple-300 { color: #a5b9ff; }
        .text-bluepurple-400 { color: #8a9eff; }
        .text-bluepurple-500 { color: #6b7eff; }
        .text-bluepurple-600 { color: #5464db; }
        .text-bluepurple-700 { color: #4050b5; }
        .text-bluepurple-800 { color: #2d3c8f; }
        .text-bluepurple-900 { color: #1e2a6a; }
        
        .border-bluepurple-50 { border-color: #f0f5ff; }
        .border-bluepurple-100 { border-color: #e0eaff; }
        .border-bluepurple-200 { border-color: #c7d5ff; }
        .border-bluepurple-300 { border-color: #a5b9ff; }
        .border-bluepurple-400 { border-color: #8a9eff; }
        .border-bluepurple-500 { border-color: #6b7eff; }
        .border-bluepurple-600 { border-color: #5464db; }
        .border-bluepurple-700 { border-color: #4050b5; }
        .border-bluepurple-800 { border-color: #2d3c8f; }
        .border-bluepurple-900 { border-color: #1e2a6a; }
        
        /* 更緊湊的存歌區 */
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }
        .compact-card {
            padding: 0.5rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .compact-name {
            font-size: 0.7rem;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .compact-count {
            font-size: 0.65rem;
            padding: 0 0.25rem;
            border-radius: 3px;
            margin-top: 0.25rem;
            display: inline-block;
        }
        
        /* 冠歌區折疊效果 */
        .crown-section-mobile {
            position: relative;
            max-height: 300px;
            overflow: hidden;
        }
        .crown-section-mobile.expanded {
            max-height: none;
        }
        .crown-section-gradient {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.9) 70%, rgba(255,255,255,1) 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
        }
        .crown-section-mobile.expanded .crown-section-gradient {
            display: none;
        }

        /* Custom font size for extra extra small */
        .text-xxs {
            font-size: 0.65rem;
            line-height: 1rem;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            pink: '#ffd1dc',
                            blue: '#d1e8ff',
                            purple: '#e8d1ff',
                            yellow: '#fff8d1',
                            green: '#d1ffdd',
                            peach: '#ffe8d1',
                            lavender: '#e0d1ff',
                            mint: '#d1fff0',
                            coral: '#ffded1',
                            lilac: '#f0d1ff',
                            bluepurple: '#d1d8ff'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-200 to-bluepurple-300 shadow-md">
            <div class="container mx-auto px-4 py-4">
                <!-- Centered title -->
                <div class="flex justify-center items-center">
                    <h1 class="text-2xl font-bold text-bluepurple-800">存歌&冠歌</h1>
                </div>
            </div>
        </header>

        <!-- Top Songs Section -->
        <section class="py-4 bg-bluepurple-50 shadow-sm">
            <div class="container mx-auto px-4">
                <h2 class="text-xl font-bold mb-4 text-bluepurple-800 flex items-center">
                    <!-- Crown icon -->
                    <svg class="w-5 h-5 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                    冠歌區
                </h2>
                
                <!-- 桌面版顯示 -->
                <div id="topSongsContainer" class="space-y-4 hidden md:block">
                    <!-- Loading placeholders -->
                    <div class="shimmer h-32 rounded-custom-lg"></div>
                    <div class="shimmer h-32 rounded-custom-lg"></div>
                </div>
                
                <!-- 手機版顯示 (可折疊) -->
                <div id="topSongsMobileContainer" class="crown-section-mobile md:hidden">
                    <div id="topSongsMobileContent" class="space-y-4">
                        <!-- Loading placeholders -->
                        <div class="shimmer h-32 rounded-custom-lg"></div>
                        <div class="shimmer h-32 rounded-custom-lg"></div>
                    </div>
                    <div class="crown-section-gradient">
                        <button id="expandCrownBtn" class="bg-white text-bluepurple-700 px-3 py-1.5 rounded-full text-sm font-medium hover:bg-bluepurple-50 transition-colors border border-bluepurple-200 shadow-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            顯示更多
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section class="py-4">
            <div class="container mx-auto px-4">
                <div class="bg-bluepurple-50 rounded-custom-lg shadow-md overflow-hidden border border-bluepurple-100">
                    <div class="p-4 border-b border-bluepurple-100 flex flex-col md:flex-row md:items-center md:justify-between relative">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-xl font-bold text-bluepurple-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-bluepurple-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"></path>
                                </svg>
                                存歌區
                            </h2>
                        </div>
                        <!-- Search and Refresh moved here, always row on mobile -->
                        <div class="flex items-center space-x-2 w-full md:w-auto">
                            <div class="relative flex-grow">
                                <input id="searchInput" type="text" placeholder="搜尋..." class="px-3 py-1.5 pr-8 rounded-custom text-gray-800 focus:outline-none focus:ring-2 focus:ring-bluepurple-300 w-full border border-bluepurple-100 text-sm">
                                <svg class="w-4 h-4 absolute right-3 top-1/2 -translate-y-1/2 text-bluepurple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <button id="refreshBtn" class="bg-white text-bluepurple-700 px-3 py-1.5 rounded-custom text-sm font-medium hover:bg-bluepurple-50 transition-colors flex-shrink-0 flex items-center border border-bluepurple-200 shadow-sm whitespace-nowrap">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span id="refreshBtnText">重新整理</span>
                                <svg id="loadingSpinner" class="animate-spin h-4 w-4 text-bluepurple-700 ml-1 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Top 10 Records Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-bluepurple-100">
                            <thead class="bg-bluepurple-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-bluepurple-700 uppercase tracking-wider">排序</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-bluepurple-700 uppercase tracking-wider">名稱</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-bluepurple-700 uppercase tracking-wider">存歌數量</th>
                                </tr>
                            </thead>
                            <tbody id="top10RecordsTableBody" class="bg-white divide-y divide-bluepurple-100">
                                <!-- Loading placeholders -->
                                <tr><td colspan="3" class="px-4 py-2"><div class="shimmer h-5 w-full rounded-custom-sm"></div></td></tr>
                                <tr><td colspan="3" class="px-4 py-2"><div class="shimmer h-5 w-full rounded-custom-sm"></div></td></tr>
                                <tr><td colspan="3" class="px-4 py-2"><div class="shimmer h-5 w-full rounded-custom-sm"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Compact Grid View for remaining records -->
                    <div class="p-4 border-t border-bluepurple-100">
                        <div id="remainingRecordsContainer" class="compact-grid">
                            <!-- Will be filled with records beyond top 10 -->
                            <div class="shimmer h-10 w-full rounded-custom-sm"></div>
                            <div class="shimmer h-10 w-full rounded-custom-sm"></div>
                            <div class="shimmer h-10 w-full rounded-custom-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer class="bg-bluepurple-100 text-bluepurple-800 py-3">
        <div class="container mx-auto px-4">
            <!-- Removed footer content -->
        </div>
    </footer>

    <script>
        // Global variables
        let allRecords = []; // Stores all records with global ranks
        let topSongs = [];
        let personColors = {}; // Store colors for each person
        let rawData = null; // Store raw data for debugging
        let currentSearchTerm = ''; // Stores the current search term

        // Crown icon for different multipliers
        const crownIcon = `<svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>`;

        // Get references to refresh button elements
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshBtnText = document.getElementById('refreshBtnText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const searchInput = document.getElementById('searchInput'); // Get search input element

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setupEventListeners();
        });

        // Set up event listeners
        function setupEventListeners() {
            refreshBtn.addEventListener('click', fetchData);
            searchInput.addEventListener('input', handleSearch);
            document.getElementById('expandCrownBtn').addEventListener('click', expandCrownSection);
            
            // Add resize event listener to handle card heights
            window.addEventListener('resize', handleResize);
        }
        
        // Expand crown section on mobile
        function expandCrownSection() {
            const container = document.getElementById('topSongsMobileContainer');
            container.classList.toggle('expanded');
            
            const button = document.getElementById('expandCrownBtn');
            if (container.classList.contains('expanded')) {
                button.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                    </svg>
                    收起
                `;
            } else {
                button.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                    顯示更多
                `;
            }
        }
        
        // Handle resize event for card heights
        function handleResize() {
            const windowWidth = window.innerWidth;
            if (windowWidth >= 768) { // md breakpoint
                equalizeCardHeights();
            } else {
                resetCardHeights();
            }
        }

        // Fetch data from Google Sheets using opensheet.elk.sh
        async function fetchData() {
            try {
                // Show loading state
                refreshBtn.disabled = true;
                refreshBtnText.textContent = '載入中...';
                loadingSpinner.classList.remove('hidden');
                
                // Spreadsheet ID and Sheet ID
                const spreadsheetId = '1z-kl4dUioRrhJaq82O283991VPtg2PfXqx4eN5fQ9-8';
                const sheetId = '450646292'; // From the gid parameter
                
                // Use opensheet.elk.sh as a proxy
                const dataUrl = `https://opensheet.elk.sh/${spreadsheetId}/${sheetId}`;
                
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json(); // opensheet returns direct JSON array
                
                // Store raw data for debugging
                rawData = data;
                console.log("Raw data from opensheet.elk.sh:", rawData);
                
                // Process records data and assign global ranks
                processMainData(data); // Pass the direct JSON array
                
                // Extract person-color mappings directly
                extractPersonColorsDirectly(data); // Pass the direct JSON array
                
                // Process top songs data
                processTopSongsData(data); // Pass the direct JSON array
                
                // Update UI, which will now apply the current search term if any
                updateUI();
                
                // Handle card heights based on current window width
                handleResize();
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('資料載入失敗，請檢查試算表連結或權限。錯誤訊息：' + error.message);
            } finally {
                // Hide loading state
                refreshBtn.disabled = false;
                refreshBtnText.textContent = '重新整理';
                loadingSpinner.classList.add('hidden');
            }
        }

        // Process the main data from the spreadsheet (存歌區)
        function processMainData(data) { // data is now an array of objects
            let tempRecords = []; 
            
            data.forEach((row, i) => {
                const name = row['名字']; // Access by column header name
                let songCount = row['存歌']; // Access by column header name

                // Ensure data exists and is not null/undefined
                if (name !== undefined && name !== null && songCount !== undefined && songCount !== null) {
                    let displaySongCount = songCount;
                    let numericSongCount = parseFloat(songCount);
                    
                    // Handle "無限" or 10000 as infinity
                    if (songCount === 10000 || (typeof songCount === 'string' && songCount.includes('（無限）'))) {
                        displaySongCount = '∞';
                        numericSongCount = Infinity;
                    } else if (isNaN(numericSongCount)) {
                        numericSongCount = 0; // Default to 0 if not a valid number
                    }
                    
                    const record = {
                        name: name,
                        songCount: displaySongCount, // Display value (with ∞ if needed)
                        originalSongCount: songCount, // Original value from sheet
                        numericSongCount: numericSongCount, // Numeric value for sorting
                        index: i // Keep original index for stable sorting
                    };
                    
                    tempRecords.push(record);
                }
            });
            
            // Sort records by song count (descending)
            tempRecords.sort((a, b) => {
                // First compare by numeric song count
                if (b.numericSongCount !== a.numericSongCount) {
                    return b.numericSongCount - a.numericSongCount;
                }
                // If counts are equal, maintain original order
                return a.index - b.index;
            });

            // Assign global rank after initial sorting of the full dataset
            tempRecords.forEach((record, idx) => {
                record.globalRank = idx + 1; // Store the 1-based global rank
            });
            
            allRecords = tempRecords; // Assign the fully processed records to the global variable
            console.log("Processed and sorted records with global ranks:", allRecords);
        }

        // Extract person-color mappings directly from the data
        function extractPersonColorsDirectly(data) { // data is now an array of objects
            personColors = {}; // Reset person colors
            
            data.forEach(row => {
                const person = row['冠歌人']; // Access by column header name
                const color = row['顏色']; // Access by column header name
                
                // Store the color for this person if not already stored
                if (person && color && !personColors[person]) {
                    // Ensure color is treated as string before checking startsWith
                    if (String(color).startsWith('#')) { 
                        // Create color styles from hex color
                        personColors[person] = getColorStylesFromHex(color);
                    } else {
                        // Use named color
                        personColors[person] = getColorStyles(color);
                    }
                }
            });
        }

        // Process the top songs data (冠歌區)
        function processTopSongsData(data) { // data is now an array of objects
            topSongs = [];
            
            data.forEach(row => {
                const person = row['冠歌人']; // Access by column header name
                const song = row['冠歌歌曲']; // Access by column header name
                const multiplier = row['倍數']; // Access by column header name
                
                // Only add if we have all required data
                if (person && song && multiplier) {
                    const topSong = {
                        person: person,
                        song: song,
                        multiplier: multiplier
                    };
                    topSongs.push(topSong);
                }
            });
            assignDefaultColorsToPersons();
        }

        // Convert color name to CSS styles
        function getColorStyles(colorName) {
            // Map of color names to CSS classes
            const colorMap = {
                '粉紅': { primary: 'bg-pastel-pink', text: 'text-pink-700', border: 'border-pink-200', isDark: false },
                '紫色': { primary: 'bg-pastel-purple', text: 'text-purple-700', border: 'border-purple-200', isDark: false },
                '藍色': { primary: 'bg-pastel-blue', text: 'text-blue-700', border: 'border-blue-200', isDark: false },
                '薰衣草': { primary: 'bg-pastel-lavender', text: 'text-purple-800', border: 'border-purple-200', isDark: false },
                '薄荷': { primary: 'bg-pastel-mint', text: 'text-green-700', border: 'border-green-200', isDark: false },
                '桃色': { primary: 'bg-pastel-peach', text: 'text-orange-700', border: 'border-orange-200', isDark: false },
                '黃色': { primary: 'bg-pastel-yellow', text: 'text-yellow-700', border: 'border-yellow-200', isDark: false },
                '珊瑚': { primary: 'bg-pastel-coral', text: 'text-red-700', border: 'border-red-200', isDark: false },
                '丁香': { primary: 'bg-pastel-lilac', text: 'text-purple-700', border: 'border-purple-200', isDark: false },
                '綠色': { primary: 'bg-pastel-green', text: 'text-green-700', border: 'border-green-200', isDark: false },
                '深藍': { primary: 'bg-blue-700', text: 'text-white', border: 'border-blue-800', isDark: true },
                '深紫': { primary: 'bg-purple-700', text: 'text-white', border: 'border-purple-800', isDark: true },
                '深綠': { primary: 'bg-green-700', text: 'text-white', border: 'border-green-800', isDark: true },
                '深紅': { primary: 'bg-red-700', text: 'text-white', border: 'border-red-800', isDark: true },
                '黑色': { primary: 'bg-gray-800', text: 'text-white', border: 'border-gray-900', isDark: true },
                '藍紫': { primary: 'bg-bluepurple-600', text: 'text-white', border: 'border-bluepurple-700', isDark: true }
            };
            
            // Return the color styles or default to bluepurple if not found
            return colorMap[colorName] || { primary: 'bg-pastel-bluepurple', text: 'text-bluepurple-700', border: 'border-bluepurple-200', isDark: false };
        }

        // Convert hex color to CSS styles
        function getColorStylesFromHex(hexColor) {
            // Determine if the color is dark (for text contrast)
            const isDark = isColorDark(hexColor);
            
            // Create inline styles using the hex color
            return {
                primary: `bg-[${hexColor}]`,
                text: isDark ? 'text-white' : 'text-gray-800',
                border: `border-[${hexColor}]`,
                hex: hexColor,
                isDark: isDark
            };
        }

        // Check if a color is dark (to determine text color)
        function isColorDark(hexColor) {
            // Remove the # if present
            hexColor = hexColor.replace('#', '');
            
            // Parse the hex color
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            
            // Calculate the brightness
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            // Return true if the color is dark
            return brightness < 128;
        }

        // Assign default colors to persons without specified colors
        function assignDefaultColorsToPersons() {
            const defaultColors = [
                '#d1d8ff', // Blue-purple
                '#d1e8ff', // Blue
                '#e8d1ff', // Purple
                '#e0d1ff', // Lavender
                '#d1fff0', // Mint
                '#ffe8d1', // Peach
                '#fff8d1', // Yellow
                '#ffded1', // Coral
                '#f0d1ff', // Lilac
                '#d1ffdd'  // Green
            ];
            
            let colorIndex = 0;
            const uniquePersons = [...new Set(topSongs.map(song => song.person))];
            
            uniquePersons.forEach(person => {
                if (!personColors[person]) {
                    const hexColor = defaultColors[colorIndex % defaultColors.length];
                    personColors[person] = getColorStylesFromHex(hexColor);
                    colorIndex++;
                }
            });
        }

        // Update the UI with the fetched data and apply search filter if needed
        function updateUI() {
            let recordsToRender = [...allRecords]; // Start with a copy of all records

            // Apply search filter if a search term exists
            if (currentSearchTerm) {
                recordsToRender = recordsToRender.filter(record =>
                    record.name.toLowerCase().includes(currentSearchTerm)
                );
            }

            renderTopSongs(); // This part doesn't depend on search, so it's fine
            renderRecordTable(recordsToRender); // Pass the filtered/unfiltered list to render
        }

        // Render the record table
        function renderRecordTable(recordsToRender) { // Accept recordsToRender as argument
            const top10RecordsTableBody = document.getElementById('top10RecordsTableBody');
            top10RecordsTableBody.innerHTML = '';
            
            if (recordsToRender.length === 0) { // Use recordsToRender here
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="3" class="px-4 py-2 text-center text-bluepurple-500">
                        沒有找到資料
                    </td>
                `;
                top10RecordsTableBody.appendChild(emptyRow);
            } else {
                const top10Records = recordsToRender.slice(0, 10); // Slice from recordsToRender
                
                top10Records.forEach((record) => { // No need for index here, use record.globalRank
                    const row = document.createElement('tr');
                    row.className = 'record-row hover:bg-bluepurple-50';
                    
                    let rankStyle = '';
                    // Use record.globalRank for styling logic based on its global rank
                    if (record.globalRank === 1) {
                        rankStyle = 'bg-yellow-100 text-yellow-800 font-bold';
                    } else if (record.globalRank === 2) {
                        rankStyle = 'bg-gray-100 text-gray-700 font-bold';
                    } else if (record.globalRank === 3) {
                        rankStyle = 'bg-amber-50 text-amber-700 font-bold';
                    } else {
                        rankStyle = 'bg-bluepurple-100 text-bluepurple-700'; 
                    }
                    
                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="inline-block rounded-full w-6 h-6 flex items-center justify-center ${rankStyle} text-xs">
                                ${record.globalRank}
                            </div>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="${record.globalRank <= 3 ? 'font-medium' : ''} text-bluepurple-900 text-sm">${record.name}</div>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="text-bluepurple-700 text-sm">${record.songCount}</div>
                        </td>
                    `;
                    top10RecordsTableBody.appendChild(row);
                });
            }
            
            const remainingRecordsContainer = document.getElementById('remainingRecordsContainer');
            remainingRecordsContainer.innerHTML = '';
            
            if (recordsToRender.length <= 10) { // Use recordsToRender here
                remainingRecordsContainer.innerHTML = '<p class="text-center text-bluepurple-500 col-span-full">沒有更多資料</p>';
            } else {
                const remainingRecords = recordsToRender.slice(10); // Slice from recordsToRender
                
                remainingRecords.forEach((record) => {
                    const recordCard = document.createElement('div');
                    recordCard.className = 'bg-bluepurple-100 rounded-custom-sm border border-bluepurple-100 compact-card hover:bg-bluepurple-50 transition-colors text-center';
                    
                    recordCard.innerHTML = `
                        <div class="compact-name text-bluepurple-800">${record.name}</div>
                        <div class="compact-count bg-bluepurple-50 text-bluepurple-700">${record.songCount}</div>
                    `;
                    
                    remainingRecordsContainer.appendChild(recordCard);
                });
            }
        }

        // Handle search input
        function handleSearch(e) {
            currentSearchTerm = e.target.value.toLowerCase().trim(); // Update global search term
            updateUI(); // Re-render UI, which will now apply the filter
        }
    </script>
</body>
</html>
