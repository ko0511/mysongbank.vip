

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>存歌&冠歌</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8faff;
        }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .record-row:hover {
            background-color: #f0f5ff;
        }
        .crown-card {
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .crown-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .song-count-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.9);
        }
        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .songs-list {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 200px;
        }
        
        /* 調整圓角為更方一點 */
        .rounded-custom {
            border-radius: 6px;
        }
        .rounded-custom-sm {
            border-radius: 4px;
        }
        .rounded-custom-lg {
            border-radius: 8px;
        }
        
        /* 自定義藍紫色調 */
        .bg-bluepurple-50 { background-color: #f0f5ff; }
        .bg-bluepurple-100 { background-color: #e0eaff; }
        .bg-bluepurple-200 { background-color: #c7d5ff; }
        .bg-bluepurple-300 { background-color: #a5b9ff; }
        .bg-bluepurple-400 { background-color: #8a9eff; }
        .bg-bluepurple-500 { background-color: #6b7eff; }
        .bg-bluepurple-600 { background-color: #5464db; }
        .bg-bluepurple-700 { background-color: #4050b5; }
        .bg-bluepurple-800 { background-color: #2d3c8f; }
        .bg-bluepurple-900 { background-color: #1e2a6a; }
        
        .text-bluepurple-50 { color: #f0f5ff; }
        .text-bluepurple-100 { color: #e0eaff; }
        .text-bluepurple-200 { color: #c7d5ff; }
        .text-bluepurple-300 { color: #a5b9ff; }
        .text-bluepurple-400 { color: #8a9eff; }
        .text-bluepurple-500 { color: #6b7eff; }
        .text-bluepurple-600 { color: #5464db; }
        .text-bluepurple-700 { color: #4050b5; }
        .text-bluepurple-800 { color: #2d3c8f; }
        .text-bluepurple-900 { color: #1e2a6a; }
        
        .border-bluepurple-50 { border-color: #f0f5ff; }
        .border-bluepurple-100 { border-color: #e0eaff; }
        .border-bluepurple-200 { border-color: #c7d5ff; }
        .border-bluepurple-300 { border-color: #a5b9ff; }
        .border-bluepurple-400 { border-color: #8a9eff; }
        .border-bluepurple-500 { border-color: #6b7eff; }
        .border-bluepurple-600 { border-color: #5464db; }
        .border-bluepurple-700 { border-color: #4050b5; }
        .border-bluepurple-800 { border-color: #2d3c8f; }
        .border-bluepurple-900 { border-color: #1e2a6a; }
        
        /* 更緊湊的存歌區 */
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }
        .compact-card {
            padding: 0.5rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .compact-name {
            font-size: 0.7rem;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .compact-count {
            font-size: 0.65rem;
            padding: 0 0.25rem;
            border-radius: 3px;
            margin-top: 0.25rem;
            display: inline-block;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            pink: '#ffd1dc',
                            blue: '#d1e8ff',
                            purple: '#e8d1ff',
                            yellow: '#fff8d1',
                            green: '#d1ffdd',
                            peach: '#ffe8d1',
                            lavender: '#e0d1ff',
                            mint: '#d1fff0',
                            coral: '#ffded1',
                            lilac: '#f0d1ff',
                            bluepurple: '#d1d8ff'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-200 to-bluepurple-300 shadow-md">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold mb-1 md:mb-0 text-bluepurple-800">存歌&冠歌</h1>
                        <p class="text-xs text-bluepurple-600">
                            最後更新時間：<span id="lastUpdate" class="font-medium">--</span>
                        </p>
                    </div>
                    <div class="flex items-center space-x-2 mt-3 md:mt-0">
                        <button id="refreshBtn" class="bg-white text-bluepurple-700 px-3 py-1.5 rounded-custom text-sm font-medium hover:bg-bluepurple-50 transition-colors flex items-center border border-bluepurple-200 shadow-sm">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            重新整理
                        </button>
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="搜尋..." class="px-3 py-1.5 rounded-custom text-gray-800 focus:outline-none focus:ring-2 focus:ring-bluepurple-300 w-32 md:w-48 border border-bluepurple-100 text-sm">
                            <svg class="w-4 h-4 absolute right-3 top-2 text-bluepurple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Top Songs Section -->
        <section class="py-4 bg-white shadow-sm">
            <div class="container mx-auto px-4">
                <h2 class="text-xl font-bold mb-4 text-bluepurple-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                    冠歌區
                </h2>
                <div id="topSongsContainer" class="space-y-4">
                    <!-- Loading placeholders -->
                    <div class="shimmer h-32 rounded-custom-lg"></div>
                    <div class="shimmer h-32 rounded-custom-lg"></div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section class="py-4">
            <div class="container mx-auto px-4">
                <div class="bg-white rounded-custom-lg shadow-md overflow-hidden border border-bluepurple-100">
                    <div class="p-4 border-b border-bluepurple-100">
                        <h2 class="text-xl font-bold text-bluepurple-800 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-bluepurple-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"></path>
                            </svg>
                            存歌區
                        </h2>
                    </div>
                    
                    <!-- Records Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-bluepurple-100">
                            <thead class="bg-bluepurple-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-bluepurple-700 uppercase tracking-wider">名稱</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-bluepurple-700 uppercase tracking-wider">存歌數量</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-bluepurple-700 uppercase tracking-wider">排序</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody" class="bg-white divide-y divide-bluepurple-100">
                                <!-- Loading placeholders -->
                                <tr><td colspan="3" class="px-4 py-2"><div class="shimmer h-5 w-full rounded-custom-sm"></div></td></tr>
                                <tr><td colspan="3" class="px-4 py-2"><div class="shimmer h-5 w-full rounded-custom-sm"></div></td></tr>
                                <tr><td colspan="3" class="px-4 py-2"><div class="shimmer h-5 w-full rounded-custom-sm"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer class="bg-bluepurple-100 text-bluepurple-800 py-3">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <p class="text-xs">© 2023 存歌&冠歌</p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let allRecords = [];
        let topSongs = [];
        let personColors = {}; // Store colors for each person
        let rawData = null; // Store raw data for debugging

        // Crown icons for different multipliers
        const crownIcon = `<svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>`;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setupEventListeners();
        });

        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', fetchData);
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // Add resize event listener to handle card heights
            window.addEventListener('resize', handleResize);
        }
        
        // Handle resize event for card heights
        function handleResize() {
            const windowWidth = window.innerWidth;
            if (windowWidth >= 768) { // md breakpoint
                equalizeCardHeights();
            } else {
                resetCardHeights();
            }
        }

        // Fetch data from Google Sheets
        async function fetchData() {
            try {
                // Show loading state
                document.getElementById('lastUpdate').textContent = "載入中...";
                
                // Spreadsheet ID from the URL
                const spreadsheetId = '1z-kl4dUioRrhJaq82O283991VPtg2PfXqx4eN5fQ9-8';
                const sheetId = '450646292'; // From the gid parameter
                
                // Add cache-busting parameter to prevent caching
                const cacheBuster = new Date().getTime();
                
                // Fetch the main data
                const mainDataUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&gid=${sheetId}&_=${cacheBuster}`;
                const mainResponse = await fetch(mainDataUrl);
                const mainText = await mainResponse.text();
                const mainData = JSON.parse(mainText.substring(47).slice(0, -2));
                
                // Store raw data for debugging
                rawData = mainData;
                console.log("Raw data:", rawData);
                
                // Process records data
                processMainData(mainData);
                
                // Extract person-color mappings directly
                extractPersonColorsDirectly(mainData);
                
                // Process top songs data
                processTopSongsData(mainData);
                
                // Update UI
                updateUI();
                
                // Set last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
                
                // Handle card heights based on current window width
                handleResize();
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('資料載入失敗，請稍後再試。');
                document.getElementById('lastUpdate').textContent = "載入失敗";
            }
        }

        // Process the main data from the spreadsheet
        function processMainData(data) {
            allRecords = [];
            
            // Skip header row
            for (let i = 1; i < data.table.rows.length; i++) {
                const row = data.table.rows[i];
                if (row.c && row.c[0] && row.c[1]) {
                    // Get the name and song count
                    const name = row.c[0].v;
                    let songCount = row.c[1].v;
                    let displaySongCount = songCount;
                    
                    // Check if songCount contains "（無限）" and replace with infinity symbol
                    if (typeof songCount === 'string' && songCount.includes('10000')) {
                        displaySongCount = '∞';
                    }
                    
                    // Create record
                    const record = {
                        name: name,
                        songCount: displaySongCount, // Display value (with ∞ if needed)
                        originalSongCount: songCount, // Original value from sheet
                        sortValue: typeof songCount === 'number' ? songCount : 
                                  (songCount === '∞' || songCount.includes('10000') ? Infinity : 0)
                    };
                    
                    allRecords.push(record);
                }
            }
            
            // Sort records by song count (descending)
            allRecords.sort((a, b) => b.sortValue - a.sortValue);
            
            console.log("Processed records:", allRecords);
        }

        // Extract person-color mappings directly from the data
        function extractPersonColorsDirectly(data) {
            personColors = {}; // Reset person colors
            
            // Directly look for person and color data in each row
            // We'll check columns H (7) and K (10) based on your information
            for (let i = 1; i < data.table.rows.length; i++) {
                const row = data.table.rows[i];
                if (!row.c) continue;
                
                // Check if we have data in both columns
                if (row.c.length > 10 && row.c[7] && row.c[10]) {
                    const person = row.c[7].v;
                    const color = row.c[10].v;
                    
                    // Store the color for this person if not already stored
                    if (person && color && !personColors[person]) {
                        // Check if color starts with # (hex color)
                        if (color.startsWith('#')) {
                            // Create color styles from hex color
                            personColors[person] = getColorStylesFromHex(color);
                        } else {
                            // Use named color
                            personColors[person] = getColorStyles(color);
                        }
                    }
                }
            }
        }

        // Process the top songs data
        function processTopSongsData(data) {
            topSongs = [];
            
            // Directly use known column indices based on your information
            const personColIndex = 7;  // Column H
            const songColIndex = 8;    // Column I
            const multiplierColIndex = 9; // Column J
            
            // Extract the top songs
            for (let i = 1; i < data.table.rows.length; i++) {
                const row = data.table.rows[i];
                if (!row.c) continue;
                
                // Skip rows without complete data
                if (row.c.length <= Math.max(personColIndex, songColIndex, multiplierColIndex)) {
                    continue;
                }
                
                if (!row.c[personColIndex] || !row.c[songColIndex] || !row.c[multiplierColIndex]) {
                    continue;
                }
                
                const person = row.c[personColIndex].v;
                const song = row.c[songColIndex].v;
                const multiplier = row.c[multiplierColIndex].v;
                
                // Only add if we have all required data
                if (person && song && multiplier) {
                    const topSong = {
                        person: person,
                        song: song,
                        multiplier: multiplier
                    };
                    topSongs.push(topSong);
                }
            }
            
            // Assign default colors to persons without specified colors
            assignDefaultColorsToPersons();
        }

        // Convert color name to CSS styles
        function getColorStyles(colorName) {
            // Map of color names to CSS classes
            const colorMap = {
                '粉紅': { primary: 'bg-pastel-pink', text: 'text-pink-700', border: 'border-pink-200', isDark: false },
                '紫色': { primary: 'bg-pastel-purple', text: 'text-purple-700', border: 'border-purple-200', isDark: false },
                '藍色': { primary: 'bg-pastel-blue', text: 'text-blue-700', border: 'border-blue-200', isDark: false },
                '薰衣草': { primary: 'bg-pastel-lavender', text: 'text-purple-800', border: 'border-purple-200', isDark: false },
                '薄荷': { primary: 'bg-pastel-mint', text: 'text-green-700', border: 'border-green-200', isDark: false },
                '桃色': { primary: 'bg-pastel-peach', text: 'text-orange-700', border: 'border-orange-200', isDark: false },
                '黃色': { primary: 'bg-pastel-yellow', text: 'text-yellow-700', border: 'border-yellow-200', isDark: false },
                '珊瑚': { primary: 'bg-pastel-coral', text: 'text-red-700', border: 'border-red-200', isDark: false },
                '丁香': { primary: 'bg-pastel-lilac', text: 'text-purple-700', border: 'border-purple-200', isDark: false },
                '綠色': { primary: 'bg-pastel-green', text: 'text-green-700', border: 'border-green-200', isDark: false },
                '深藍': { primary: 'bg-blue-700', text: 'text-white', border: 'border-blue-800', isDark: true },
                '深紫': { primary: 'bg-purple-700', text: 'text-white', border: 'border-purple-800', isDark: true },
                '深綠': { primary: 'bg-green-700', text: 'text-white', border: 'border-green-800', isDark: true },
                '深紅': { primary: 'bg-red-700', text: 'text-white', border: 'border-red-800', isDark: true },
                '黑色': { primary: 'bg-gray-800', text: 'text-white', border: 'border-gray-900', isDark: true },
                '藍紫': { primary: 'bg-bluepurple-600', text: 'text-white', border: 'border-bluepurple-700', isDark: true }
            };
            
            // Return the color styles or default to bluepurple if not found
            return colorMap[colorName] || { primary: 'bg-pastel-bluepurple', text: 'text-bluepurple-700', border: 'border-bluepurple-200', isDark: false };
        }

        // Convert hex color to CSS styles
        function getColorStylesFromHex(hexColor) {
            // Determine if the color is dark (for text contrast)
            const isDark = isColorDark(hexColor);
            
            // Create inline styles using the hex color
            return {
                primary: `bg-[${hexColor}]`,
                text: isDark ? 'text-white' : 'text-gray-800',
                border: `border-[${hexColor}]`,
                hex: hexColor,
                isDark: isDark
            };
        }

        // Check if a color is dark (to determine text color)
        function isColorDark(hexColor) {
            // Remove the # if present
            hexColor = hexColor.replace('#', '');
            
            // Parse the hex color
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            
            // Calculate the brightness
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            // Return true if the color is dark
            return brightness < 128;
        }

        // Assign default colors to persons without specified colors
        function assignDefaultColorsToPersons() {
            const defaultColors = [
                '#d1d8ff', // Blue-purple
                '#d1e8ff', // Blue
                '#e8d1ff', // Purple
                '#e0d1ff', // Lavender
                '#d1fff0', // Mint
                '#ffe8d1', // Peach
                '#fff8d1', // Yellow
                '#ffded1', // Coral
                '#f0d1ff', // Lilac
                '#d1ffdd'  // Green
            ];
            
            let colorIndex = 0;
            const uniquePersons = [...new Set(topSongs.map(song => song.person))];
            
            uniquePersons.forEach(person => {
                if (!personColors[person]) {
                    const hexColor = defaultColors[colorIndex % defaultColors.length];
                    personColors[person] = getColorStylesFromHex(hexColor);
                    colorIndex++;
                }
            });
        }

        // Update the UI with the fetched data
        function updateUI() {
            renderTopSongs();
            renderRecordTable();
        }

        // Render the top songs section with new design
        function renderTopSongs() {
            const container = document.getElementById('topSongsContainer');
            container.innerHTML = '';
            
            if (topSongs.length === 0) {
                container.innerHTML = '<p class="text-center text-bluepurple-500">沒有冠歌資料</p>';
                return;
            }
            
            // Group songs by person
            const songsByPerson = {};
            topSongs.forEach(song => {
                if (!songsByPerson[song.person]) {
                    songsByPerson[song.person] = [];
                }
                songsByPerson[song.person].push(song);
            });
            
            // Sort persons by number of songs (most songs first)
            const sortedPersons = Object.keys(songsByPerson).sort((a, b) => 
                songsByPerson[b].length - songsByPerson[a].length
            );
            
            // Create a container for all person cards
            const personsContainer = document.createElement('div');
            personsContainer.className = 'grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3';
            
            // Display each person as a card
            sortedPersons.forEach(person => {
                const personSongs = songsByPerson[person];
                const personColor = personColors[person] || { primary: 'bg-pastel-bluepurple', text: 'text-gray-800', border: 'border-bluepurple-200', isDark: false };
                
                // Create a card for this person
                const personCard = document.createElement('div');
                personCard.className = 'bg-white rounded-custom shadow-sm overflow-hidden border border-gray-200 relative crown-card';
                
                // Determine text color based on background darkness
                const textColorClass = personColor.isDark ? 'text-white' : 'text-gray-800';
                
                // Create background style for card content
                let bgStyle = '';
                if (personColor.hex) {
                    // For hex colors, use inline style with opacity
                    const bgColor = personColor.hex + '33'; // 20% opacity
                    bgStyle = `style="background-color: ${bgColor};"`;
                } else {
                    // For named colors, use opacity class
                    bgStyle = `class="${personColor.primary.replace('bg-', 'bg-opacity-20 bg-')}"`;
                }
                
                // Add person header with crown icon
                const headerBgClass = personColor.hex ? `style="background-color: ${personColor.hex};"` : `class="${personColor.primary}"`;
                
                personCard.innerHTML = `
                    <div ${headerBgClass} class="p-2 relative">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-1 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            <h3 class="font-bold text-sm ${textColorClass}">${person}</h3>
                        </div>
                        <span class="song-count-badge text-gray-800 border ${personColor.border}">
                            ${personSongs.length} 首
                        </span>
                    </div>
                    <div ${bgStyle} class="card-content">
                        <ul class="songs-list p-2 space-y-1">
                            ${personSongs.map(song => {
                                return `
                                <li class="flex items-center justify-between bg-white p-1.5 rounded-custom-sm shadow-sm border ${personColor.border}">
                                    <span class="font-medium text-gray-800 truncate mr-2 text-xs">${song.song}</span>
                                    <span class="flex items-center text-gray-800 text-xs font-bold">
                                        ${crownIcon}
                                        <span class="ml-0.5">${song.multiplier}倍</span>
                                    </span>
                                </li>`;
                            }).join('')}
                        </ul>
                    </div>
                `;
                
                personsContainer.appendChild(personCard);
            });
            
            container.appendChild(personsContainer);
            
            // Make all cards the same height on desktop
            if (window.innerWidth >= 768) { // md breakpoint
                setTimeout(() => {
                    equalizeCardHeights();
                }, 100);
            }
        }

        // Make all crown cards the same height
        function equalizeCardHeights() {
            const cards = document.querySelectorAll('.crown-card');
            if (cards.length === 0) return;
            
            // Reset heights first
            cards.forEach(card => {
                card.style.height = 'auto';
            });
            
            // Find the tallest card
            let maxHeight = 0;
            cards.forEach(card => {
                maxHeight = Math.max(maxHeight, card.offsetHeight);
            });
            
            // Set all cards to the tallest height
            cards.forEach(card => {
                card.style.height = `${maxHeight}px`;
            });
        }
        
        // Reset card heights to auto
        function resetCardHeights() {
            const cards = document.querySelectorAll('.crown-card');
            cards.forEach(card => {
                card.style.height = 'auto';
            });
        }

        // Render the record table
        function renderRecordTable() {
            const recordsTableBody = document.getElementById('recordsTableBody');
            recordsTableBody.innerHTML = '';
            
            if (allRecords.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="3" class="px-4 py-2 text-center text-bluepurple-500">
                        沒有找到資料
                    </td>
                `;
                recordsTableBody.appendChild(emptyRow);
            } else {
                // Render all records
                allRecords.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.className = 'record-row hover:bg-bluepurple-50';
                    
                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="text-bluepurple-900 text-sm">${record.name}</div>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="text-bluepurple-700 text-sm">${record.songCount}</div>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <div class="text-bluepurple-500 text-sm">${index + 1}</div>
                        </td>
                    `;
                    recordsTableBody.appendChild(row);
                });
            }
        }

        // Handle search input
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Reset to original data
                updateUI();
                return;
            }
            
            // Filter records based on search term
            const filteredRecords = allRecords.filter(record => 
                record.name.toLowerCase().includes(searchTerm)
            );
            
            // Temporarily replace allRecords with filtered results
            const originalRecords = [...allRecords];
            allRecords = filteredRecords;
            
            // Update UI with filtered results
            renderRecordTable(); // Only update the records table, not the top songs
            
            // Restore original data
            allRecords = originalRecords;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'94f0835aa32a4a00',t:'MTc0OTgwNjQzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
